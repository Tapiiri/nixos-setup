#!/usr/bin/env -S python3
"""Executable entrypoint for `rebuild`.

This file is meant to be runnable as a standalone executable (including via
`sudo rebuild`). When installed or symlinked into a PATH directory, Python's
import path won't include the repo checkout. To keep things maintainable and
testable, we keep the implementation in `scripts_py.rebuild` and bootstrap the
import path here.
"""

from __future__ import annotations

import sys
from pathlib import Path


def _find_repo_root(start: Path) -> Path | None:
    """Walk upwards from `start` until we find a directory containing `flake.nix`."""

    cur = start
    for _ in range(8):
        if (cur / "flake.nix").is_file() and (cur / "scripts_py").is_dir():
            return cur
        if cur.parent == cur:
            break
        cur = cur.parent
    return None


def _bootstrap_import_path() -> None:
    exe = Path(__file__).resolve()
    # Common cases:
    # - running from repo: <repo>/scripts/rebuild
    # - symlinked from ~/.local/bin -> <repo>/scripts/rebuild
    # - copied into PATH alongside scripts_py/ (rare)
    candidates = [exe.parent.parent, exe.parent, exe]

    repo_root = None
    for c in candidates:
        repo_root = _find_repo_root(c) or repo_root
        if repo_root:
            break

    if repo_root and str(repo_root) not in sys.path:
        sys.path.insert(0, str(repo_root))


_bootstrap_import_path()

from scripts_py.rebuild import main  # noqa: E402


if __name__ == "__main__":
    raise SystemExit(main())
