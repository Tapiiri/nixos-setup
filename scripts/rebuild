#!/usr/bin/env -S python3
"""Executable entrypoint for `rebuild`.

This file is meant to be runnable as a standalone executable (including via
`sudo rebuild`). When installed or symlinked into a PATH directory, Python's
import path won't include the repo checkout. To keep things maintainable and
testable, we keep the implementation in `scripts_py.rebuild` and bootstrap the
import path here.
"""

from __future__ import annotations

import sys
from pathlib import Path


def _bootstrap_repo_root_on_syspath() -> None:
    """Add repo root to sys.path so we can import scripts_py.*

    This entrypoint must not depend on importing `scripts_py` before it has fixed
    sys.path.
    """

    exe = Path(__file__).resolve()
    cur = exe.parent.parent

    for _ in range(8):
        if (cur / "flake.nix").is_file() and (cur / "scripts_py").is_dir():
            sys.path.insert(0, str(cur))
            return
        if cur.parent == cur:
            return
        cur = cur.parent


_bootstrap_repo_root_on_syspath()

from scripts_py.rebuild import main  # noqa: E402


if __name__ == "__main__":
    raise SystemExit(main())
